generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Resource {
  id          String   @id @default(uuid())
  title       String
  description String?
  type        String   // "VIDEO" | "BOOK" | "EXERCISE"
  url         String
  imageUrl    String
  duration    String?
  author      String?
  createdAt   DateTime @default(now())
}

// Usuario registrado (Lead)
model User {
  id            String   @id @default(uuid())
  email         String   @unique
  name          String?
  image         String?
  passwordHash  String?  @map("password_hash")
  role          String?   // "student", "professional", "executive"
  goal          String?   // "fear", "diction", "leadership"
  credits       Int      @default(3)
  plan          String   @default("FREE") // "FREE" | "STARTER" | "PREMIUM"
  magicToken    String?  @unique // Token para acceso sin password
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Lemon Squeezy Integration
  lemonSqueezyCustomerId     String?   @unique @map("lemon_squeezy_customer_id")
  lemonSqueezySubscriptionId String?   @unique @map("lemon_squeezy_subscription_id")
  subscriptionStatus         String?   @map("subscription_status") // "active", "on_trial", "paused", "past_due", "unpaid", "cancelled", "expired"
  subscriptionRenewsAt       DateTime? @map("subscription_renews_at")

  sessions      VoiceSession[]
  usage         Usage?

  @@map("users")
}

// Control de uso (Free Tier limit by Fingerprint or User)
model Usage {
  id              String   @id @default(uuid())
  userId          String?  @unique @map("user_id") // Relación con usuario registrado
  fingerprint     String   @unique // Para usuarios anónimos
  planType        String   @map("plan_type") @default("FREE")
  totalAnalyses   Int      @map("total_analyses") @default(0)
  
  // Weekly Tracking (Legacy/Future proof)
  weeklyAnalyses  Int      @map("weekly_analyses") @default(0)
  weekStart       DateTime @default(now()) @map("week_start")

  // Monthly Tracking (For Voice Pro & Elite)
  monthlyAnalyses Int      @map("monthly_analyses") @default(0)
  monthStart      DateTime @default(now()) @map("month_start")

  lastAnalysisAt  DateTime @default(now()) @map("last_analysis_at")
  
  user            User?    @relation(fields: [userId], references: [id])

  @@map("usage")
}

// Sesiones de análisis de voz del usuario
model VoiceSession {
  id                        String   @id @default(uuid())
  userId                    String   @map("user_id") // Puede ser ID de User o Fingerprint
  user                      User?    @relation(fields: [userId], references: [id]) // Opcional si es anónimo
  createdAt                 DateTime @default(now()) @map("created_at")
  
  // Transcripción
  transcription             String
  transcriptionWithSilences String   @map("transcription_with_silences")
  
  // Métricas técnicas
  wordsPerMinute            Int      @map("words_per_minute")
  avgPauseDuration          Decimal  @map("avg_pause_duration") @db.Decimal(5, 2)
  pauseCount                Int      @map("pause_count")
  fillerCount               Int      @map("filler_count")
  pitchVariation            Decimal  @map("pitch_variation") @db.Decimal(5, 2)
  energyStability           Decimal  @map("energy_stability") @db.Decimal(5, 2)
  durationSeconds           Decimal  @map("duration_seconds") @db.Decimal(6, 2)
  
  // Score de autoridad
  authorityLevel            String   @map("authority_level")
  authorityScore            Int      @map("authority_score")
  strengths                 Json     // Array de strings
  weaknesses                Json     // Array de strings
  priorityAdjustment        String   @map("priority_adjustment")
  
  // Feedback de GPT
  feedbackDiagnostico       String   @map("feedback_diagnostico")
  feedbackLoQueSuma         Json     @map("feedback_lo_que_suma")
  feedbackLoQueResta        Json     @map("feedback_lo_que_resta")
  feedbackDecision          String   @map("feedback_decision")
  feedbackPayoff            String   @map("feedback_payoff")
  
  @@map("voice_sessions")
  @@index([userId])
  @@index([createdAt(sort: Desc)])
}

// --- SECURITY HARDENING MODELS ---

// 1. Wallet Drainer Protection
// Tracks unique devices across multiple accounts
model DeviceIntegrity {
  id              String   @id @default(uuid())
  fingerprintHash String   @unique // High-entropy hash (Canvas + WebGL + IP + UA)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Track usage independent of User ID
  freeAnalysesUsed Int     @default(0)
  isBlocked        Boolean @default(false)
  
  // Audit trail
  lastIp          String?
  linkedEmails    String[] // Emails associated with this device
  
  @@map("device_integrity")
}

// 2. Anti-Replay Protection for Webhooks
model WebhookEvent {
  id        String   @id @default(uuid())
  eventId   String   @unique // The unique ID from Lemon Squeezy header/body
  provider  String   // "lemon_squeezy"
  processedAt DateTime @default(now())
  status    String   // "success", "failed", "ignored"
  
  @@map("webhook_events")
}

// 3. Honeypot & IP Ban List
model SuspiciousActivity {
  id        String   @id @default(uuid())
  ip        String
  endpoint  String   // e.g. "/admin-login", "/wp-admin"
  reason    String   // "HONEYPOT_TRIGGER", "EXCESSIVE_LOGIN_FAIL"
  severity  String   // "LOW", "HIGH", "CRITICAL"
  createdAt DateTime @default(now())
  
  @@map("suspicious_activity")
}
